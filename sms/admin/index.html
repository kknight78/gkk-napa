<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMS Admin | G&KK NAPA</title>
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#004b8d" />
  <link rel="icon" href="/assets/favicon-32.jpg" type="image/jpeg">
  <style>
    :root {
      --napa-blue: #0A0094;
      --napa-yellow: #FFC836;
      --bg: #06115a;
      --white: #ffffff;
      --green: #8ecf8e;
      --red: #ff6b6b;
      --orange: #ffb347;
      --dim: rgba(255,255,255,.5);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--white);
    }
    .wrap { max-width: 800px; margin: 0 auto; padding: 20px 18px; }
    h1 { text-transform: uppercase; letter-spacing: .4px; margin: 0 0 8px; font-size: 24px; }
    h2 { font-size: 16px; margin: 24px 0 12px; color: var(--napa-yellow); text-transform: uppercase; letter-spacing: .3px; }
    .logo-banner { background: #0A0094; padding: 20px 16px; text-align: center; }
    .logo-banner a { display: inline-block; }
    .header-logo { max-width: 280px; width: 100%; height: auto; }

    /* Login */
    .login-card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      color: var(--white);
      font-size: 16px;
      font-family: inherit;
    }
    input::placeholder, textarea::placeholder { color: rgba(255,255,255,.4); }
    textarea { resize: vertical; min-height: 80px; }
    select option { background: #1a1a4a; color: var(--white); }
    label { display: block; font-weight: 700; margin: 14px 0 6px; font-size: 14px; }
    label:first-child { margin-top: 0; }

    button {
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .3px;
    }
    .btn-primary { background: var(--napa-yellow); color: #111; }
    .btn-danger { background: var(--red); color: #fff; }
    .btn-secondary { background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); color: var(--white); }
    .btn-success { background: var(--green); color: #111; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(255,255,255,.1);
      padding-bottom: 0;
    }
    .tab {
      padding: 12px 18px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .3px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: rgba(255,255,255,.5);
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    .tab.active {
      color: var(--napa-yellow);
      border-bottom-color: var(--napa-yellow);
    }
    .tab:hover:not(.active) { color: rgba(255,255,255,.8); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .kpi-num { font-size: 28px; font-weight: 800; color: var(--napa-yellow); }
    .kpi-label { font-size: 12px; color: var(--dim); text-transform: uppercase; letter-spacing: .3px; margin-top: 4px; }

    /* Dashboard sections */
    .dash-section { margin-bottom: 24px; }
    .dash-section h2 { margin: 0 0 12px; }

    .alert-card {
      background: rgba(255,107,107,.08);
      border: 1px solid rgba(255,107,107,.25);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    .alert-card.info {
      background: rgba(100,180,255,.08);
      border-color: rgba(100,180,255,.25);
    }
    .alert-card .count { font-weight: 800; font-size: 18px; color: var(--napa-yellow); margin-right: 12px; }

    .action-card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .action-card .action-info { flex: 1; }
    .action-card .action-label { font-weight: 700; font-size: 14px; }
    .action-card .action-desc { font-size: 12px; color: var(--dim); margin-top: 2px; }
    .action-card .action-count { font-weight: 800; font-size: 22px; color: var(--napa-yellow); margin: 0 16px; }

    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-source { font-size: 11px; color: var(--dim); background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 4px; }

    /* Personal text cards */
    .pt-card {
      background: rgba(255,255,255,.06);
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 10px;
    }
    .pt-card.done { opacity: .4; }
    .pt-header { margin-bottom: 10px; font-size: 15px; }
    .pt-steps { display: flex; flex-direction: column; gap: 10px; font-size: 14px; }
    .pt-step { display: flex; align-items: center; gap: 8px; }
    .pt-phone {
      color: var(--napa-yellow);
      font-weight: 700;
      font-size: 16px;
      text-decoration: none;
    }
    .btn-copy-msg {
      background: var(--napa-blue);
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-copy-msg.copied { background: #388e3c; }
    .btn-mark-sent {
      background: #388e3c;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }

    /* Customer cards */
    .customer-item {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }
    .customer-info { flex: 1; }
    .customer-name { font-weight: 700; font-size: 15px; }
    .customer-detail { font-size: 13px; color: rgba(255,255,255,.6); margin-top: 3px; }
    .customer-actions { display: flex; gap: 6px; flex-shrink: 0; flex-wrap: wrap; }
    .customer-actions button { padding: 8px 12px; font-size: 11px; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      margin-left: 8px;
    }
    .badge-subscribed { background: rgba(142,207,142,.2); color: var(--green); }
    .badge-invited { background: rgba(255,179,71,.2); color: var(--orange); }
    .badge-stopped { background: rgba(255,107,107,.15); color: #ffb0b0; }
    .badge-none { background: rgba(255,255,255,.08); color: var(--dim); }
    .badge-mobile { background: rgba(142,207,142,.12); color: var(--green); font-size:10px; }
    .badge-landline { background: rgba(255,107,107,.12); color: #ffb0b0; font-size:10px; }
    .badge-voip { background: rgba(100,180,255,.15); color: #8cc4ff; font-size:10px; }

    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-bar select, .filter-bar input {
      width: auto;
      flex: 1;
      min-width: 120px;
    }

    .form-card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .form-row { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    .form-row > * { flex: 1; min-width: 120px; }

    /* Campaign cards */
    .campaign-item {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .campaign-item:hover { border-color: rgba(255,255,255,.3); }
    .campaign-name { font-weight: 700; font-size: 15px; }
    .campaign-meta { font-size: 13px; color: rgba(255,255,255,.5); margin-top: 4px; }
    .campaign-stats { display: flex; gap: 16px; margin-top: 8px; font-size: 13px; }
    .campaign-stats span { color: var(--dim); }
    .stat-label { margin-right: 4px; }

    /* Message char counter */
    .char-count { font-size: 12px; color: var(--dim); text-align: right; margin-top: 4px; }
    .char-count.warn { color: var(--orange); }
    .char-count.over { color: var(--red); }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal h2 { margin-top: 0; }

    .error { color: #ffd0d0; font-weight: 700; margin-top: 10px; }
    .success { color: var(--green); font-weight: 700; margin-top: 10px; }
    .empty { color: var(--dim); font-style: italic; padding: 20px 0; }
    a { color: var(--napa-yellow); }
    .back-link { display: inline-block; margin-top: 20px; font-size: 14px; }

    .recipient-preview {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 14px;
    }
    .recipient-preview strong { color: var(--napa-yellow); }

    .store-breakdown {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .store-chip {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
    }
    .store-chip strong { color: var(--napa-yellow); }

    /* Campaign detail messages */
    .msg-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
    }
    .msg-status { font-weight: 700; text-transform: uppercase; font-size: 11px; }
    .msg-delivered { color: var(--green); }
    .msg-sent, .msg-queued { color: var(--orange); }
    .msg-failed, .msg-undelivered { color: var(--red); }

    @media (max-width: 600px) {
      .tabs { overflow-x: auto; }
      .tab { padding: 10px 12px; font-size: 12px; white-space: nowrap; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .filter-bar { flex-direction: column; }
      .filter-bar select, .filter-bar input { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="logo-banner">
    <a href="/"><img src="/assets/napa-auto-parts-g+kk-combo.svg" alt="NAPA Auto Parts - Back to Home" class="header-logo"></a>
  </div>

  <div class="wrap">
    <!-- ═══ Login Screen ═══ -->
    <div id="loginScreen">
      <h1>SMS Admin</h1>
      <div class="login-card">
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Enter admin password" />
        <div style="margin-top:14px;">
          <button class="btn-primary" id="btnLogin">Log In</button>
        </div>
        <div class="error" id="loginError" style="display:none;"></div>
      </div>
    </div>

    <!-- ═══ Admin Screen ═══ -->
    <div id="adminScreen" style="display:none;">
      <h1>SMS Marketing</h1>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="customers">Customers</button>
        <button class="tab" data-tab="send">Send SMS</button>
        <button class="tab" data-tab="history">History</button>
      </div>

      <!-- ═══ Tab 1: Dashboard ═══ -->
      <div class="tab-content active" id="tab-dashboard">

        <!-- Alerts -->
        <div class="dash-section" id="dashAlerts"></div>

        <!-- KPIs -->
        <div class="kpi-grid" id="kpiGrid">
          <div class="kpi-card"><div class="kpi-num" id="kpiTotal">—</div><div class="kpi-label">Total Customers</div></div>
          <div class="kpi-card"><div class="kpi-num" id="kpiSubscribed">—</div><div class="kpi-label">Subscribed</div></div>
          <div class="kpi-card"><div class="kpi-num" id="kpiConversion">—</div><div class="kpi-label">Invite → Subscribe</div></div>
          <div class="kpi-card"><div class="kpi-num" id="kpiMessages">—</div><div class="kpi-label">Messages (Month)</div></div>
        </div>

        <!-- Actions -->
        <div class="dash-section">
          <h2>Actions</h2>
          <div id="dashActions"></div>
        </div>

        <!-- Personal Text Panel (hidden by default) -->
        <div class="dash-section" id="personalTextPanel" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>Personal Text List</h2>
            <button class="btn-secondary" onclick="document.getElementById('personalTextPanel').style.display='none'" style="padding:4px 12px;font-size:13px;">Close</button>
          </div>
          <p style="color:#aaa;font-size:13px;margin:0 0 12px;">Open this page on your phone. Tap the number to open Messages, copy the message, paste &amp; send, then mark it done.</p>
          <div id="personalTextList"></div>
        </div>

        <!-- Source Breakdown + Store Breakdown -->
        <div style="display:flex;gap:16px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <h2>By Source</h2>
            <div id="sourceBreakdown"></div>
          </div>
          <div style="flex:1;min-width:200px;">
            <h2>By Store</h2>
            <div class="store-breakdown" id="storeBreakdown"></div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="dash-section" style="margin-top:16px;">
          <h2>Recent Activity (This Week)</h2>
          <div id="recentActivity"></div>
        </div>

        <!-- Utilities -->
        <div style="margin-top:20px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-secondary" id="btnExportCsv">Export CSV</button>
          <button class="btn-secondary" id="btnPrintQr">Print QR Codes</button>
          <button class="btn-secondary" id="btnGenShortCodes">Generate Short Codes</button>
        </div>
      </div>

      <!-- ═══ Tab 2: Customers ═══ -->
      <div class="tab-content" id="tab-customers">
        <div class="filter-bar">
          <select id="filterStore">
            <option value="">All Stores</option>
            <option value="danville">Danville, IL</option>
            <option value="cayuga">Cayuga, IN</option>
            <option value="rockville">Rockville, IN</option>
            <option value="covington">Covington, IN</option>
          </select>
          <select id="filterStatus">
            <option value="">All Statuses</option>
            <option value="none">None</option>
            <option value="invited">Invited</option>
            <option value="subscribed">Subscribed</option>
            <option value="stopped">Stopped</option>
          </select>
          <select id="filterLineType">
            <option value="">All Lines</option>
            <option value="mobile">Mobile</option>
            <option value="landline">Landline</option>
            <option value="voip">VoIP</option>
          </select>
          <select id="filterEmail">
            <option value="">All</option>
            <option value="has">Has Email</option>
            <option value="no">No Email</option>
          </select>
          <div style="flex:2;position:relative;min-width:120px;">
            <input id="filterSearch" type="text" placeholder="Search name, phone, email..." style="width:100%;padding-right:36px;" />
            <button id="btnClearSearch" type="button" style="display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.15);border:none;color:#fff;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px;line-height:1;padding:0;">&times;</button>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div id="customerCount" style="font-size:13px;color:rgba(255,255,255,.5);"></div>
          <div style="display:flex;gap:8px;">
            <button class="btn-secondary" id="btnCheckLineTypes" title="Check line types for new customers via Twilio Lookup">Check Lines</button>
            <button class="btn-secondary" id="btnInviteAll" title="Send invite emails to filtered customers with email + status none/invited">Invite Filtered</button>
            <button class="btn-primary" id="btnAddCustomer">+ Add Customer</button>
          </div>
        </div>

        <div id="customerList"></div>
      </div>

      <!-- ═══ Tab 3: Send SMS ═══ -->
      <div class="tab-content" id="tab-send">
        <div class="form-card">
          <h2 style="margin-top:0;">New SMS Campaign</h2>

          <label for="campaignName">Campaign Name</label>
          <input id="campaignName" type="text" placeholder="e.g., February Promo" maxlength="100" />

          <label for="campaignBody">Message</label>
          <textarea id="campaignBody" placeholder="Type your message..." maxlength="1500" style="min-height:120px;"></textarea>
          <div class="char-count" id="charCount">0 / 1,500</div>
          <div style="font-size:12px;color:rgba(255,255,255,.4);margin-top:2px;">"Reply STOP to opt out." will be appended automatically.</div>

          <label for="campaignImage">Image</label>
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:4px;">
            <label style="display:flex;align-items:center;gap:6px;margin:0;font-size:13px;cursor:pointer;">
              <input type="radio" name="imageOption" value="logo" checked style="width:auto;accent-color:var(--napa-yellow);" /> Store logo
            </label>
            <label style="display:flex;align-items:center;gap:6px;margin:0;font-size:13px;cursor:pointer;">
              <input type="radio" name="imageOption" value="custom" style="width:auto;accent-color:var(--napa-yellow);" /> Custom URL
            </label>
            <label style="display:flex;align-items:center;gap:6px;margin:0;font-size:13px;cursor:pointer;">
              <input type="radio" name="imageOption" value="none" style="width:auto;accent-color:var(--napa-yellow);" /> No image (SMS only)
            </label>
          </div>
          <div id="customImageRow" style="display:none;margin-bottom:4px;">
            <input id="campaignImageUrl" type="url" placeholder="https://example.com/image.png" />
          </div>
          <div id="imagePreview" style="margin-bottom:8px;">
            <img src="https://gkk-napa.com/assets/sms-logo.png" alt="Preview" style="max-width:200px;border-radius:8px;border:1px solid rgba(255,255,255,.14);" />
          </div>

          <label for="campaignStore">Send To</label>
          <select id="campaignStore">
            <option value="">All Stores</option>
            <option value="danville">Danville, IL</option>
            <option value="cayuga">Cayuga, IN</option>
            <option value="rockville">Rockville, IN</option>
            <option value="covington">Covington, IN</option>
          </select>

          <div class="recipient-preview" id="recipientPreview">
            Loading recipient count...
          </div>

          <div style="margin-top:16px;">
            <button class="btn-primary" id="btnSend" style="width:100%;font-size:16px;padding:14px;">Send Campaign</button>
          </div>
          <div class="error" id="sendError" style="display:none;"></div>
          <div class="success" id="sendSuccess" style="display:none;"></div>
        </div>
      </div>

      <!-- ═══ Tab 4: History ═══ -->
      <div class="tab-content" id="tab-history">
        <div id="campaignList"></div>
      </div>
    </div>
  </div>

  <!-- ═══ Add/Edit Customer Modal ═══ -->
  <div class="modal-overlay" id="customerModal">
    <div class="modal">
      <h2 id="modalTitle">Add Customer</h2>
      <input type="hidden" id="modalCustomerId" />

      <label for="modalName">Name</label>
      <input id="modalName" type="text" placeholder="Business or contact name" maxlength="100" />

      <label for="modalPhone">Phone Number</label>
      <input id="modalPhone" type="tel" placeholder="(555) 555-1234" />

      <label for="modalEmail">Email (optional)</label>
      <input id="modalEmail" type="email" placeholder="contact@business.com" />

      <label for="modalStore">Store</label>
      <select id="modalStore">
        <option value="">— Select —</option>
        <option value="danville">Danville, IL</option>
        <option value="cayuga">Cayuga, IN</option>
        <option value="rockville">Rockville, IN</option>
        <option value="covington">Covington, IN</option>
      </select>

      <label for="modalNotes">Notes (optional)</label>
      <textarea id="modalNotes" placeholder="Account number, special instructions..." maxlength="500" style="min-height:60px;"></textarea>

      <div id="subscribeUrlRow" style="display:none;">
        <label>Subscribe URL</label>
        <div style="display:flex;gap:8px;">
          <input id="modalSubscribeUrl" type="text" readonly style="flex:1;opacity:.7;cursor:text;font-size:13px;" />
          <button type="button" class="btn-secondary" id="btnCopyUrl" style="flex-shrink:0;padding:12px 16px;">Copy</button>
        </div>
      </div>

      <div class="form-row" style="margin-top:16px;">
        <button class="btn-primary" id="btnModalSave">Save</button>
        <button class="btn-secondary" id="btnModalCancel">Cancel</button>
      </div>
      <div class="error" id="modalError" style="display:none;"></div>
    </div>
  </div>

  <!-- ═══ Invite Preview Modal ═══ -->
  <div class="modal-overlay" id="inviteModal">
    <div class="modal" style="max-width:700px;">
      <h2 style="margin-top:0;">Email Invitation Preview</h2>
      <div id="inviteRecipientInfo" style="font-size:13px;color:var(--dim);margin-bottom:16px;"></div>

      <label for="inviteSubject">Subject Line</label>
      <input id="inviteSubject" type="text" value="Subscribe to text updates from G&KK NAPA" maxlength="200" />

      <label for="inviteIntro">Intro Message</label>
      <textarea id="inviteIntro" style="min-height:60px;" maxlength="500">We're excited to offer text updates from your local store! Subscribe to get:</textarea>

      <label for="inviteBullets">Benefits (one per line)</label>
      <textarea id="inviteBullets" style="min-height:80px;" maxlength="500">Order-ready notifications
Store hours &amp; closure alerts
Occasional deals &amp; promotions</textarea>

      <label>Preview</label>
      <div id="invitePreview" style="background:#fff;border-radius:8px;padding:0;overflow:hidden;max-height:400px;overflow-y:auto;"></div>

      <div class="form-row" style="margin-top:16px;">
        <button class="btn-primary" id="btnInviteSend">Send Invitations</button>
        <button class="btn-secondary" id="btnInviteCancel">Cancel</button>
      </div>
      <div class="error" id="inviteError" style="display:none;"></div>
      <div class="success" id="inviteSuccess" style="display:none;"></div>
    </div>
  </div>

  <!-- ═══ Campaign Detail Modal ═══ -->
  <div class="modal-overlay" id="campaignModal">
    <div class="modal">
      <h2 id="campaignDetailTitle">Campaign Details</h2>
      <div id="campaignDetailBody"></div>
      <div style="margin-top:16px;">
        <button class="btn-secondary" id="btnCampaignClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    const WORKER_BASE = "https://gkk-napa-sms.kellyraeknight78.workers.dev";

    const STORE_NAMES = {
      danville: "Danville, IL",
      cayuga: "Cayuga, IN",
      rockville: "Rockville, IN",
      covington: "Covington, IN",
    };

    const STATUS_BADGE = {
      subscribed: '<span class="badge badge-subscribed">Subscribed</span>',
      invited: '<span class="badge badge-invited">Invited</span>',
      stopped: '<span class="badge badge-stopped">Stopped</span>',
      none: '<span class="badge badge-none">None</span>',
    };

    let authToken = "";
    let allCustomers = [];

    // ─── Auth ────────────────────────────────────────────────
    function authHeaders() {
      return { "Content-Type": "application/json", Authorization: `Bearer ${authToken}` };
    }

    const loginScreen = document.getElementById("loginScreen");
    const adminScreen = document.getElementById("adminScreen");
    const passwordEl = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const loginError = document.getElementById("loginError");

    btnLogin.addEventListener("click", async () => {
      loginError.style.display = "none";
      const pw = passwordEl.value.trim();
      if (!pw) { loginError.textContent = "Please enter a password."; loginError.style.display = "block"; return; }

      authToken = pw;
      try {
        const resp = await fetch(`${WORKER_BASE}/admin/login`, { method: "POST", headers: authHeaders() });
        if (!resp.ok) {
          authToken = "";
          loginError.textContent = "Invalid password.";
          loginError.style.display = "block";
          return;
        }
        loginScreen.style.display = "none";
        adminScreen.style.display = "block";
        loadDashboard();
        loadCustomers();
      } catch {
        authToken = "";
        loginError.textContent = "Could not connect to server.";
        loginError.style.display = "block";
      }
    });

    passwordEl.addEventListener("keydown", (e) => { if (e.key === "Enter") btnLogin.click(); });

    // ─── Tabs ────────────────────────────────────────────────
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add("active");

        // Refresh data when switching tabs
        if (tab.dataset.tab === "dashboard") loadDashboard();
        if (tab.dataset.tab === "customers") loadCustomers();
        if (tab.dataset.tab === "send") updateRecipientPreview();
        if (tab.dataset.tab === "history") loadCampaigns();
      });
    });

    // ─── Dashboard ───────────────────────────────────────────
    async function loadDashboard() {
      try {
        const [dashResp, statsResp] = await Promise.all([
          fetch(`${WORKER_BASE}/admin/dashboard`, { headers: authHeaders() }),
          fetch(`${WORKER_BASE}/admin/stats`, { headers: authHeaders() }),
        ]);
        const dash = await dashResp.json();
        const stats = await statsResp.json();

        // KPIs
        document.getElementById("kpiTotal").textContent = dash.kpis.total_customers;
        document.getElementById("kpiSubscribed").textContent = dash.kpis.total_subscribed;
        document.getElementById("kpiConversion").textContent = dash.kpis.conversion_rate + "%";
        document.getElementById("kpiMessages").textContent = stats.messages_this_month;

        // Alerts
        const alertsEl = document.getElementById("dashAlerts");
        let alertHtml = "";
        if (dash.alerts.failed_sms > 0)
          alertHtml += `<div class="alert-card"><div><span class="count">${dash.alerts.failed_sms}</span> failed SMS this week</div></div>`;
        if (dash.alerts.new_from_stripe > 0)
          alertHtml += `<div class="alert-card info"><div><span class="count">${dash.alerts.new_from_stripe}</span> new customer${dash.alerts.new_from_stripe !== 1 ? 's' : ''} from Stripe payments this week</div></div>`;
        if (dash.alerts.new_from_web > 0)
          alertHtml += `<div class="alert-card info"><div><span class="count">${dash.alerts.new_from_web}</span> new subscriber${dash.alerts.new_from_web !== 1 ? 's' : ''} from web form this week</div></div>`;
        if (dash.alerts.new_from_quick_subscribe > 0)
          alertHtml += `<div class="alert-card info"><div><span class="count">${dash.alerts.new_from_quick_subscribe}</span> new one-click subscriber${dash.alerts.new_from_quick_subscribe !== 1 ? 's' : ''} this week</div></div>`;
        alertsEl.innerHTML = alertHtml || "";

        // Actions
        const actionsEl = document.getElementById("dashActions");
        const actions = dash.actions;
        actionsEl.innerHTML = `
          ${actions.ready_to_invite > 0 ? `<div class="action-card">
            <div class="action-info"><div class="action-label">Ready to Invite</div><div class="action-desc">Has email + mobile, never invited</div></div>
            <div class="action-count">${actions.ready_to_invite}</div>
            <button class="btn-primary" onclick="dashAction('invite-ready')">Invite All</button>
            <button class="btn-secondary" onclick="dashAction('print-qr-ready')" style="margin-left:6px;">Print QR</button>
          </div>` : ''}
          ${actions.mobile_no_email > 0 ? `<div class="action-card">
            <div class="action-info"><div class="action-label">Mobile, No Email</div><div class="action-desc">Personal text from your phone, or print QR for invoices</div></div>
            <div class="action-count">${actions.mobile_no_email}</div>
            <button class="btn-success" onclick="dashAction('personal-text')">Text List</button>
            <button class="btn-secondary" onclick="dashAction('print-qr-no-email')" style="margin-left:6px;">Print QR</button>
          </div>` : ''}
          ${actions.stale_invites > 0 ? `<div class="action-card">
            <div class="action-info"><div class="action-label">Stale Invites (30+ days)</div><div class="action-desc">Invited but never subscribed</div></div>
            <div class="action-count">${actions.stale_invites}</div>
            <button class="btn-secondary" onclick="dashAction('re-invite')">Re-Invite</button>
          </div>` : ''}
          ${actions.email_only_no_mobile > 0 ? `<div class="action-card">
            <div class="action-info"><div class="action-label">Email Only, No Mobile</div><div class="action-desc">Can invite by email, links to web form</div></div>
            <div class="action-count">${actions.email_only_no_mobile}</div>
            <button class="btn-secondary" onclick="dashAction('invite-email-only')">Invite All</button>
          </div>` : ''}
          ${actions.needs_outreach > 0 ? `<div class="action-card">
            <div class="action-info"><div class="action-label">Needs Outreach</div><div class="action-desc">No email + no mobile — call or snail mail</div></div>
            <div class="action-count">${actions.needs_outreach}</div>
            <button class="btn-secondary" onclick="dashAction('export-outreach')">Export List</button>
            <button class="btn-secondary" onclick="dashAction('print-qr-generic')" style="margin-left:6px;">Print QR</button>
          </div>` : ''}
          ${actions.ready_to_invite === 0 && actions.mobile_no_email === 0 && actions.stale_invites === 0 && actions.email_only_no_mobile === 0 && actions.needs_outreach === 0 ? '<div class="empty">No actions needed right now!</div>' : ''}
        `;

        // Source breakdown
        const sourceEl = document.getElementById("sourceBreakdown");
        const sourceNames = { admin: "Admin Added", import: "Imported", payment: "Stripe Payment", web: "Web Form", "quick-subscribe": "One-Click", unknown: "Unknown" };
        sourceEl.innerHTML = dash.source_breakdown.map(s =>
          `<div class="store-chip"><strong>${s.count}</strong> ${sourceNames[s.source] || s.source}</div>`
        ).join("");

        // Store breakdown
        const storeEl = document.getElementById("storeBreakdown");
        if (stats.store_breakdown && stats.store_breakdown.length > 0) {
          storeEl.innerHTML = stats.store_breakdown.map(s =>
            `<div class="store-chip"><strong>${s.count}</strong> ${STORE_NAMES[s.store] || s.store || "No Store"}</div>`
          ).join("");
        } else {
          storeEl.innerHTML = '<div class="empty">No customers yet.</div>';
        }

        // Recent activity
        const activityEl = document.getElementById("recentActivity");
        if (dash.recent_activity.length > 0) {
          activityEl.innerHTML = dash.recent_activity.map(c => {
            const sourceLabel = sourceNames[c.source] || c.source || "";
            const date = new Date(c.created_at).toLocaleDateString("en-US", { month: "short", day: "numeric" });
            return `<div class="activity-item">
              <div>${esc(c.name || "Unnamed")} ${c.store ? '<span style="color:var(--dim);">· ' + (STORE_NAMES[c.store] || c.store) + '</span>' : ''}</div>
              <div style="display:flex;gap:8px;align-items:center;">
                ${sourceLabel ? `<span class="activity-source">${sourceLabel}</span>` : ''}
                ${STATUS_BADGE[c.sms_status] || ''}
                <span style="color:var(--dim);font-size:12px;">${date}</span>
              </div>
            </div>`;
          }).join("");
        } else {
          activityEl.innerHTML = '<div class="empty">No new activity this week.</div>';
        }

      } catch (e) {
        console.error("Dashboard error:", e);
        document.getElementById("kpiTotal").textContent = "?";
      }
    }

    // ─── Personal Text Helpers ─────────────────────────────────
    window.copyMsg = function(btn) {
      const msg = btn.getAttribute("data-msg");
      navigator.clipboard.writeText(msg).then(() => {
        btn.textContent = "Copied!";
        btn.classList.add("copied");
        setTimeout(() => { btn.textContent = "Copy Message"; btn.classList.remove("copied"); }, 2000);
      });
    };

    window.markPersonalText = async function(id) {
      const now = new Date().toISOString();
      const resp = await fetch(`${WORKER_BASE}/admin/customers/${id}`, {
        method: "PATCH",
        headers: { ...authHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({ sms_status: "invited", invite_sent_at: now, notes_append: "Personal text sent " + now.slice(0, 10) }),
      });
      if (resp.ok) {
        const card = document.getElementById("pt-" + id);
        card.classList.add("done");
        card.querySelector(".btn-mark-sent").textContent = "Done!";
        card.querySelector(".btn-mark-sent").disabled = true;
      }
    };

    // ─── QR Print Helper ──────────────────────────────────────
    function printQrPage(title, subtitle, items) {
      // items: array of { name, phone, url, short_code } or { generic: true, url }
      const win = window.open("", "_blank");
      win.document.write('<html><head><title>' + esc(title) + '</title>'
        + '<style>body{font-family:Arial,sans-serif;margin:20px;}'
        + '.qr-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;}'
        + '.qr-item{text-align:center;page-break-inside:avoid;border:1px solid #ddd;border-radius:8px;padding:12px;}'
        + '.qr-item img{width:150px;height:150px;}'
        + '.qr-name{font-weight:700;font-size:14px;margin:8px 0 4px;}'
        + '.qr-phone{font-size:12px;color:#333;margin:2px 0;}'
        + '.qr-fallback{font-size:10px;color:#888;margin-top:4px;}'
        + '.qr-fallback a{color:#004b8d;}'
        + '@media print{.no-print{display:none!important;}}</style></head><body>'
        + '<div class="no-print" style="margin-bottom:16px;">'
        + '<button onclick="window.print()" style="padding:10px 20px;font-size:16px;cursor:pointer;">Print</button>'
        + '<span style="margin-left:12px;color:#666;">' + esc(subtitle) + '</span>'
        + '</div>'
        + '<div class="qr-grid">' + items.map(item => {
          const qrApi = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(item.url);
          if (item.generic) {
            return '<div class="qr-item">'
              + '<img src="' + qrApi + '" alt="QR">'
              + '<div class="qr-name">' + esc(item.name || "G&KK NAPA") + '</div>'
              + '<div class="qr-phone">Scan to subscribe to text updates</div>'
              + '<div class="qr-fallback">Or visit: <a href="' + item.url + '">' + item.url.replace('https://', '') + '</a></div>'
              + '</div>';
          }
          const phone = item.phone ? item.phone.replace(/^\+1(\d{3})(\d{3})(\d{4})$/, '($1) $2-$3') : '';
          return '<div class="qr-item">'
            + '<img src="' + qrApi + '" alt="QR">'
            + '<div class="qr-name">' + esc(item.name || "Unnamed") + '</div>'
            + (phone ? '<div class="qr-phone">Texts will be sent to ' + phone + '</div>' : '')
            + '<div class="qr-fallback">Not your number? Subscribe at <a href="https://gkk-napa.com/sms/subscribe">gkk-napa.com/sms/subscribe</a></div>'
            + '</div>';
        }).join('') + '</div></body></html>');
      win.document.close();
    }

    // ─── Dashboard Actions ────────────────────────────────────
    window.dashAction = async function(action) {
      if (action === "invite-ready") {
        // Fetch customers with email + mobile + status none
        const resp = await fetch(`${WORKER_BASE}/admin/customers?status=none`, { headers: authHeaders() });
        const customers = await resp.json();
        const eligible = customers.filter(c => c.email && c.line_type === "mobile");
        if (eligible.length === 0) { alert("No eligible customers."); return; }
        openInviteModal(eligible.map(c => c.id), `Sending email invites to ${eligible.length} customer(s) with email + mobile`);
      } else if (action === "print-qr-no-email") {
        const resp = await fetch(`${WORKER_BASE}/admin/customers`, { headers: authHeaders() });
        const customers = await resp.json();
        const eligible = customers.filter(c => !c.email && c.line_type === "mobile" && c.short_code);
        if (eligible.length === 0) { alert("No eligible customers with short codes."); return; }
        printQrPage("QR Mailers — Mobile, No Email", eligible.length + " QR codes — mobile customers without email",
          eligible.map(c => ({ name: c.name, phone: c.phone, url: "https://gkk-napa.com/s/" + c.short_code })));
      } else if (action === "print-qr-ready") {
        const resp = await fetch(`${WORKER_BASE}/admin/customers?status=none`, { headers: authHeaders() });
        const customers = await resp.json();
        const eligible = customers.filter(c => c.email && c.line_type === "mobile" && c.short_code);
        if (eligible.length === 0) { alert("No eligible customers with short codes."); return; }
        printQrPage("QR Codes — Ready to Invite", eligible.length + " QR codes — customers with email + mobile",
          eligible.map(c => ({ name: c.name, phone: c.phone, url: "https://gkk-napa.com/s/" + c.short_code })));
      } else if (action === "print-qr-generic") {
        const resp = await fetch(`${WORKER_BASE}/admin/customers`, { headers: authHeaders() });
        const customers = await resp.json();
        const eligible = customers.filter(c => !c.email && (!c.phone || c.line_type !== "mobile") && c.sms_status !== "subscribed");
        if (eligible.length === 0) { alert("No eligible customers."); return; }
        printQrPage("QR Codes — Needs Outreach", eligible.length + " generic QR codes — include with invoice or mail",
          eligible.map(c => ({ name: c.name, generic: true, url: "https://gkk-napa.com/sms/subscribe" })));
      } else if (action === "personal-text") {
        const resp = await fetch(`${WORKER_BASE}/admin/customers`, { headers: authHeaders() });
        const customers = await resp.json();
        const eligible = customers.filter(c => !c.email && c.line_type === "mobile" && c.short_code && c.sms_status !== "subscribed");
        if (eligible.length === 0) { alert("No eligible customers."); return; }
        // Show the personal text panel
        const panel = document.getElementById("personalTextPanel");
        const list = document.getElementById("personalTextList");
        list.innerHTML = eligible.map(c => {
          const phone = c.phone.replace(/^\+1(\d{3})(\d{3})(\d{4})$/, '($1) $2-$3');
          const url = 'https://gkk-napa.com/s/' + c.short_code;
          const name = c.name || 'Valued Customer';
          const firstName = name.split(' ')[0];
          const msg = "Hey " + firstName + ", it's Brian at G&KK NAPA! We have a new text updates program for order notifications, store hours & deals. If you're interested, tap here to subscribe: " + url;
          return '<div class="pt-card" id="pt-' + c.id + '">'
            + '<div class="pt-header">'
            + '<strong>' + esc(c.name || 'Unnamed') + '</strong>'
            + (c.store ? ' <span style="color:#888;font-size:12px;">(' + esc(c.store) + ')</span>' : '')
            + '</div>'
            + '<div class="pt-steps">'
            + '<div class="pt-step">1. <a href="sms:' + c.phone.replace('+1', '') + '" class="pt-phone">' + phone + '</a> <span style="color:#888;font-size:12px;">tap to open Messages</span></div>'
            + '<div class="pt-step">2. <button class="btn-copy-msg" onclick="copyMsg(this)" data-msg="' + esc(msg).replace(/"/g, '&quot;') + '">Copy Message</button></div>'
            + '<div class="pt-step">3. Paste into Messages &amp; send</div>'
            + '<div class="pt-step">4. <button class="btn-mark-sent" onclick="markPersonalText(\'' + c.id + '\')">Mark Sent</button></div>'
            + '</div>'
            + '</div>';
        }).join('');
        panel.style.display = "block";
        panel.scrollIntoView({ behavior: "smooth" });
      } else if (action === "re-invite") {
        const resp = await fetch(`${WORKER_BASE}/admin/customers?status=invited`, { headers: authHeaders() });
        const customers = await resp.json();
        const thirtyDaysAgo = new Date(Date.now() - 30 * 86400000).toISOString();
        const stale = customers.filter(c => c.email && c.invite_sent_at && c.invite_sent_at < thirtyDaysAgo);
        if (stale.length === 0) { alert("No stale invites found."); return; }
        openInviteModal(stale.map(c => c.id), `Re-sending to ${stale.length} customer(s) invited 30+ days ago`);
      } else if (action === "invite-email-only") {
        const resp = await fetch(`${WORKER_BASE}/admin/customers`, { headers: authHeaders() });
        const customers = await resp.json();
        const eligible = customers.filter(c => c.email && (!c.phone || c.line_type === "landline") && (c.sms_status === "none" || c.sms_status === "invited"));
        if (eligible.length === 0) { alert("No eligible customers."); return; }
        openInviteModal(eligible.map(c => c.id), `Sending to ${eligible.length} email-only customer(s) (no mobile)`, false);
      } else if (action === "export-outreach") {
        const resp = await fetch(`${WORKER_BASE}/admin/customers`, { headers: authHeaders() });
        const customers = await resp.json();
        const needs = customers.filter(c => (!c.email || c.email === "") && (!c.phone || c.line_type === "landline"));
        if (needs.length === 0) { alert("No customers need outreach."); return; }
        let csv = "Name,Phone,Store,Notes\\n";
        needs.forEach(c => {
          csv += `"${(c.name||'').replace(/"/g,'""')}",${c.phone||''},"${STORE_NAMES[c.store]||c.store||''}","${(c.notes||'').replace(/"/g,'""')}"\\n`;
        });
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "needs-outreach.csv";
        a.click();
      }
    };

    // ─── Utility Buttons ──────────────────────────────────────
    document.getElementById("btnExportCsv").addEventListener("click", async () => {
      const resp = await fetch(`${WORKER_BASE}/admin/export`, { headers: authHeaders() });
      const blob = await resp.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `gkk-napa-customers-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    });

    document.getElementById("btnPrintQr").addEventListener("click", async () => {
      const resp = await fetch(`${WORKER_BASE}/admin/customers`, { headers: authHeaders() });
      const customers = await resp.json();
      const mobileWithCodes = customers.filter(c => c.short_code && c.line_type === 'mobile');
      if (mobileWithCodes.length === 0) { alert("No mobile customers with short codes."); return; }
      printQrPage("QR Codes — G&KK NAPA", mobileWithCodes.length + " QR codes (mobile only)",
        mobileWithCodes.map(c => ({ name: c.name, phone: c.phone, url: "https://gkk-napa.com/s/" + c.short_code })));
    });

    document.getElementById("btnGenShortCodes").addEventListener("click", async () => {
      const btn = document.getElementById("btnGenShortCodes");
      btn.disabled = true;
      btn.textContent = "Generating...";
      try {
        const resp = await fetch(`${WORKER_BASE}/admin/generate-short-codes`, { method: "POST", headers: authHeaders() });
        const data = await resp.json();
        btn.textContent = data.generated > 0 ? `${data.generated} created!` : "All set!";
        setTimeout(() => { btn.textContent = "Generate Short Codes"; btn.disabled = false; }, 2000);
      } catch { btn.textContent = "Error"; btn.disabled = false; }
    });

    // ─── Customers ───────────────────────────────────────────
    const filterStore = document.getElementById("filterStore");
    const filterStatus = document.getElementById("filterStatus");
    const filterSearch = document.getElementById("filterSearch");
    const customerList = document.getElementById("customerList");
    const customerCount = document.getElementById("customerCount");

    const btnClearSearch = document.getElementById("btnClearSearch");

    const filterLineType = document.getElementById("filterLineType");
    const filterEmail = document.getElementById("filterEmail");
    [filterStore, filterStatus, filterLineType, filterEmail].forEach(el => el.addEventListener("change", loadCustomers));
    let searchTimeout;
    filterSearch.addEventListener("input", () => {
      btnClearSearch.style.display = filterSearch.value ? "block" : "none";
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(loadCustomers, 300);
    });
    btnClearSearch.addEventListener("click", () => {
      filterSearch.value = "";
      btnClearSearch.style.display = "none";
      loadCustomers();
    });

    async function loadCustomers() {
      const params = new URLSearchParams();
      if (filterStore.value) params.set("store", filterStore.value);
      if (filterStatus.value) params.set("status", filterStatus.value);
      if (filterSearch.value.trim()) params.set("q", filterSearch.value.trim());

      try {
        const resp = await fetch(`${WORKER_BASE}/admin/customers?${params}`, { headers: authHeaders() });
        allCustomers = await resp.json();
        let filtered = allCustomers;
        if (filterLineType.value) {
          filtered = filtered.filter(c => c.line_type === filterLineType.value);
        }
        if (filterEmail.value === "has") {
          filtered = filtered.filter(c => c.email);
        } else if (filterEmail.value === "no") {
          filtered = filtered.filter(c => !c.email);
        }
        renderCustomers(filtered);
      } catch {
        customerList.innerHTML = '<div class="error">Failed to load customers.</div>';
      }
    }

    function renderCustomers(customers) {
      customerCount.textContent = `${customers.length} customer${customers.length !== 1 ? "s" : ""}`;

      if (customers.length === 0) {
        customerList.innerHTML = '<div class="empty">No customers match the filters.</div>';
        return;
      }

      customerList.innerHTML = customers.map(c => `
        <div class="customer-item" data-id="${c.id}">
          <div class="customer-info">
            <div class="customer-name">
              ${esc(c.name || "Unnamed")}
              ${STATUS_BADGE[c.sms_status] || ""}
              ${c.line_type ? `<span class="badge badge-${c.line_type}">${c.line_type}</span>` : ""}
            </div>
            <div class="customer-detail">${esc(c.phone)}${c.store ? " &middot; " + (STORE_NAMES[c.store] || c.store) : ""}</div>
            ${c.email ? `<div class="customer-detail">${esc(c.email)}</div>` : ""}
            ${c.notes ? `<div class="customer-detail" style="font-style:italic;">${esc(c.notes)}</div>` : ""}
          </div>
          <div class="customer-actions">
            ${c.sms_status === "none" || c.sms_status === "invited" ? `<button class="btn-success" onclick="inviteOne(${c.id})" ${!c.email ? "disabled title='No email'" : "title='Send invite email'"}>Invite</button>` : ""}
            <button class="btn-secondary" onclick="editCustomer(${c.id})">Edit</button>
            <button class="btn-danger" onclick="deleteCustomer(${c.id}, '${esc(c.name || c.phone)}')">Del</button>
          </div>
        </div>
      `).join("");
    }

    // ─── Add/Edit Customer Modal ─────────────────────────────
    const customerModal = document.getElementById("customerModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalCustomerId = document.getElementById("modalCustomerId");
    const modalName = document.getElementById("modalName");
    const modalPhone = document.getElementById("modalPhone");
    const modalEmail = document.getElementById("modalEmail");
    const modalStore = document.getElementById("modalStore");
    const modalNotes = document.getElementById("modalNotes");
    const modalError = document.getElementById("modalError");

    document.getElementById("btnAddCustomer").addEventListener("click", () => {
      modalTitle.textContent = "Add Customer";
      modalCustomerId.value = "";
      modalName.value = "";
      modalPhone.value = "";
      modalPhone.disabled = false;
      modalEmail.value = "";
      modalStore.value = "";
      modalNotes.value = "";
      modalError.style.display = "none";
      document.getElementById("subscribeUrlRow").style.display = "none";
      customerModal.classList.add("open");
    });

    window.editCustomer = async function(id) {
      const c = allCustomers.find(x => x.id === id);
      if (!c) return;
      modalTitle.textContent = "Edit Customer";
      modalCustomerId.value = c.id;
      modalName.value = c.name || "";
      modalPhone.value = c.phone ? formatPhone(c.phone) : "";
      modalPhone.disabled = false;
      modalEmail.value = c.email || "";
      modalStore.value = c.store || "";
      modalNotes.value = c.notes || "";
      modalError.style.display = "none";

      // Show subscribe URL (prefer short URL if available)
      if (c.short_code) {
        document.getElementById("modalSubscribeUrl").value = `https://gkk-napa.com/s/${c.short_code}`;
      } else {
        const token = await generateSubscribeToken(c.id);
        document.getElementById("modalSubscribeUrl").value =
          `https://gkk-napa-sms.kellyraeknight78.workers.dev/quick-subscribe?token=${token}`;
      }
      document.getElementById("subscribeUrlRow").style.display = "block";

      customerModal.classList.add("open");
    };

    document.getElementById("btnModalCancel").addEventListener("click", () => {
      customerModal.classList.remove("open");
    });

    document.getElementById("btnModalSave").addEventListener("click", async () => {
      modalError.style.display = "none";
      const id = modalCustomerId.value;
      const data = {
        name: modalName.value.trim(),
        phone: modalPhone.value.trim(),
        email: modalEmail.value.trim(),
        store: modalStore.value,
        notes: modalNotes.value.trim(),
      };

      if (!data.phone && !data.email) {
        modalError.textContent = "Phone number or email is required.";
        modalError.style.display = "block";
        return;
      }

      try {
        const url = id ? `${WORKER_BASE}/admin/customers/${id}` : `${WORKER_BASE}/admin/customers`;
        const method = id ? "PUT" : "POST";
        const resp = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(data) });
        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.error || "Failed to save.");
        }
        customerModal.classList.remove("open");
        loadCustomers();
      } catch (e) {
        modalError.textContent = e.message;
        modalError.style.display = "block";
      }
    });

    // ─── Check Line Types ──────────────────────────────────
    document.getElementById("btnCheckLineTypes").addEventListener("click", async () => {
      const btn = document.getElementById("btnCheckLineTypes");
      btn.disabled = true;
      btn.textContent = "Checking...";
      try {
        const resp = await fetch(`${WORKER_BASE}/admin/check-line-types`, { method: "POST", headers: authHeaders() });
        const data = await resp.json();
        btn.textContent = data.checked > 0 ? `${data.checked} checked!` : "All set!";
        loadCustomers();
        setTimeout(() => { btn.textContent = "Check Lines"; btn.disabled = false; }, 2000);
      } catch {
        btn.textContent = "Error";
        setTimeout(() => { btn.textContent = "Check Lines"; btn.disabled = false; }, 2000);
      }
    });

    // ─── Delete Customer ─────────────────────────────────────
    window.deleteCustomer = async function(id, name) {
      if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
      await new Promise(r => setTimeout(r, 50));
      try {
        const resp = await fetch(`${WORKER_BASE}/admin/customers/${id}/delete`, { method: "POST", headers: authHeaders() });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          alert(`Delete failed: ${err.error || resp.statusText}`);
          return;
        }
        loadCustomers();
      } catch (e) {
        alert(`Delete failed: ${e.message}\n\nURL: ${WORKER_BASE}/admin/customers/${id}/delete\nPlease check DevTools Network tab for details.`);
      }
    };

    // ─── Invite (with preview modal) ───────────────────────
    const inviteModal = document.getElementById("inviteModal");
    const inviteSubject = document.getElementById("inviteSubject");
    const inviteIntro = document.getElementById("inviteIntro");
    const inviteBullets = document.getElementById("inviteBullets");
    const invitePreview = document.getElementById("invitePreview");
    const inviteRecipientInfo = document.getElementById("inviteRecipientInfo");
    const inviteError = document.getElementById("inviteError");
    const inviteSuccess = document.getElementById("inviteSuccess");
    let pendingInviteIds = [];

    let previewHasMobile = true; // tracks which version of email preview to show

    function buildPreviewHtml(intro, bullets) {
      const bulletHtml = bullets.split("\n").filter(b => b.trim()).map(b =>
        `<tr><td style="padding:6px 0;font-size:15px;color:#333;">&#10003;&nbsp;&nbsp;${esc(b.trim())}</td></tr>`
      ).join("");
      const phoneSection = previewHasMobile
        ? `<div style="padding:0 24px 16px;text-align:center;">
            <p style="margin:0 0 12px;font-size:14px;color:#333;">Texts will be sent to <strong>(555) 555-1234</strong><br><span style="font-size:12px;color:#888;">Not a mobile number? <span style="color:#0A0094;">Subscribe with a different number</span></span></p>
          </div>`
        : '';
      const buttonText = previewHasMobile ? 'Subscribe with One Click' : 'Subscribe Now';
      return `<div style="font-family:Arial,sans-serif;">
        <div style="background-color:#0A0094;">
          <img src="https://gkk-napa.com/assets/pay-email-logo.png" alt="NAPA Auto Parts" height="75" style="display:block;height:75px;width:auto;">
          <div style="color:#ffffff;font-size:13px;padding:0 0 10px 12px;">G&amp;KK Store Updates</div>
        </div>
        <div style="padding:32px 24px 16px;">
          <h1 style="margin:0 0 16px;font-size:22px;color:#111;font-weight:700;">Hi [Customer Name],</h1>
          <p style="margin:0 0 16px;font-size:16px;color:#333;line-height:1.6;">${esc(intro)}</p>
          <table cellpadding="0" cellspacing="0" style="margin:0 0 24px;">${bulletHtml}</table>
        </div>
        ${phoneSection}
        <div style="text-align:center;padding:0 24px 16px;">
          <span style="display:inline-block;background-color:#FFC836;color:#0A0094;font-size:16px;font-weight:700;padding:14px 32px;border-radius:8px;text-transform:uppercase;letter-spacing:0.5px;">${buttonText}</span>
        </div>
        ${!previewHasMobile ? '<div style="padding:0 24px 8px;text-align:center;"><p style="margin:0;font-size:13px;color:#888;">Button links to <span style="color:#0A0094;">gkk-napa.com/sms/subscribe</span></p></div>' : ''}
        <div style="padding:0 24px 24px;">
          <p style="margin:0;font-size:12px;color:#888;line-height:1.5;text-align:center;">By clicking subscribe, you agree to receive SMS messages from G&amp;KK NAPA Auto Parts about order updates, store hours/closures, and occasional promotions. Message frequency varies. Msg &amp; data rates may apply. Consent is not a condition of purchase. Reply STOP to opt out, HELP for help. See <span style="color:#0A0094;">Privacy Policy</span> and <span style="color:#0A0094;">Terms of Service</span>.</p>
        </div>
        <div style="background-color:#f9fafb;padding:16px 24px;border-top:1px solid #e5e7eb;">
          <p style="margin:0;font-size:12px;color:#888;text-align:center;">G&amp;KK NAPA Auto Parts &middot; gkk-napa.com</p>
        </div>
      </div>`;
    }

    function updateInvitePreview() {
      invitePreview.innerHTML = buildPreviewHtml(inviteIntro.value, inviteBullets.value);
    }

    inviteIntro.addEventListener("input", updateInvitePreview);
    inviteBullets.addEventListener("input", updateInvitePreview);

    function openInviteModal(customerIds, recipientLabel, hasMobile) {
      pendingInviteIds = customerIds;
      previewHasMobile = hasMobile !== false; // default true
      inviteRecipientInfo.textContent = recipientLabel;
      inviteError.style.display = "none";
      inviteSuccess.style.display = "none";
      document.getElementById("btnInviteSend").disabled = false;
      document.getElementById("btnInviteSend").textContent = "Send Invitations";
      updateInvitePreview();
      inviteModal.classList.add("open");
    }

    window.inviteOne = function(id) {
      const c = allCustomers.find(x => x.id === id);
      if (!c || !c.email) return;
      openInviteModal([id], `Sending to: ${c.name || c.email} (${c.email})`);
    };

    document.getElementById("btnInviteAll").addEventListener("click", () => {
      const eligible = allCustomers.filter(c => c.email && (c.sms_status === "none" || c.sms_status === "invited"));
      if (eligible.length === 0) {
        alert("No eligible customers in current filter (need email + status none/invited).");
        return;
      }
      openInviteModal(eligible.map(c => c.id), `Sending to ${eligible.length} customer(s) with email + status none/invited`);
    });

    document.getElementById("btnInviteCancel").addEventListener("click", () => {
      inviteModal.classList.remove("open");
    });

    document.getElementById("btnInviteSend").addEventListener("click", async () => {
      inviteError.style.display = "none";
      inviteSuccess.style.display = "none";
      const btn = document.getElementById("btnInviteSend");
      btn.disabled = true;
      btn.textContent = "Sending...";

      try {
        const resp = await fetch(`${WORKER_BASE}/admin/invite`, {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({
            customer_ids: pendingInviteIds,
            subject: inviteSubject.value.trim(),
            intro: inviteIntro.value.trim(),
            bullets: inviteBullets.value.trim().split("\n").filter(b => b.trim()),
          }),
        });
        const data = await resp.json();
        if (resp.ok) {
          inviteSuccess.textContent = `Done! ${data.sent} sent, ${data.failed} failed out of ${data.total_eligible} eligible.`;
          inviteSuccess.style.display = "block";
          btn.textContent = "Sent!";
          loadCustomers();
          setTimeout(() => inviteModal.classList.remove("open"), 2000);
        } else {
          throw new Error(data.error || "Failed to send.");
        }
      } catch (e) {
        inviteError.textContent = e.message;
        inviteError.style.display = "block";
        btn.disabled = false;
        btn.textContent = "Send Invitations";
      }
    });

    // ─── Send SMS Campaign ───────────────────────────────────
    const campaignName = document.getElementById("campaignName");
    const campaignBody = document.getElementById("campaignBody");
    const campaignStore = document.getElementById("campaignStore");
    const charCount = document.getElementById("charCount");
    const recipientPreview = document.getElementById("recipientPreview");
    const sendError = document.getElementById("sendError");
    const sendSuccess = document.getElementById("sendSuccess");

    campaignBody.addEventListener("input", () => {
      const len = campaignBody.value.length;
      charCount.textContent = `${len.toLocaleString()} / 1,500`;
      charCount.className = "char-count" + (len > 1500 ? " over" : len > 1400 ? " warn" : "");
    });

    // Image option handling
    const imagePreview = document.getElementById("imagePreview");
    const customImageRow = document.getElementById("customImageRow");
    const campaignImageUrl = document.getElementById("campaignImageUrl");
    const LOGO_URL = "https://gkk-napa.com/assets/sms-logo.png";

    document.querySelectorAll('input[name="imageOption"]').forEach(radio => {
      radio.addEventListener("change", () => {
        const val = radio.value;
        customImageRow.style.display = val === "custom" ? "block" : "none";
        if (val === "logo") {
          imagePreview.innerHTML = `<img src="${LOGO_URL}" alt="Preview" style="max-width:200px;border-radius:8px;border:1px solid rgba(255,255,255,.14);" />`;
        } else if (val === "none") {
          imagePreview.innerHTML = '<div style="font-size:13px;color:var(--dim);padding:8px 0;">No image — will send as SMS (cheaper)</div>';
        } else {
          const url = campaignImageUrl.value.trim();
          imagePreview.innerHTML = url
            ? `<img src="${esc(url)}" alt="Preview" style="max-width:200px;border-radius:8px;border:1px solid rgba(255,255,255,.14);" />`
            : '<div style="font-size:13px;color:var(--dim);padding:8px 0;">Enter an image URL above</div>';
        }
      });
    });
    campaignImageUrl.addEventListener("input", () => {
      const url = campaignImageUrl.value.trim();
      if (url) {
        imagePreview.innerHTML = `<img src="${esc(url)}" alt="Preview" style="max-width:200px;border-radius:8px;border:1px solid rgba(255,255,255,.14);" />`;
      }
    });

    function getImageUrl() {
      const selected = document.querySelector('input[name="imageOption"]:checked').value;
      if (selected === "logo") return LOGO_URL;
      if (selected === "custom") return campaignImageUrl.value.trim() || null;
      return null; // "none" — no image, plain SMS
    }

    campaignStore.addEventListener("change", updateRecipientPreview);

    async function updateRecipientPreview() {
      const params = new URLSearchParams({ status: "subscribed" });
      if (campaignStore.value) params.set("store", campaignStore.value);

      try {
        const resp = await fetch(`${WORKER_BASE}/admin/customers?${params}`, { headers: authHeaders() });
        const customers = await resp.json();
        const storeName = campaignStore.value ? (STORE_NAMES[campaignStore.value] || campaignStore.value) : "all stores";
        recipientPreview.innerHTML = `Will send to <strong>${customers.length}</strong> subscribed customer${customers.length !== 1 ? "s" : ""} at ${storeName}.`;
      } catch {
        recipientPreview.innerHTML = "Could not load recipient count.";
      }
    }

    document.getElementById("btnSend").addEventListener("click", async () => {
      sendError.style.display = "none";
      sendSuccess.style.display = "none";

      const name = campaignName.value.trim();
      const body = campaignBody.value.trim();

      if (!name) { sendError.textContent = "Campaign name is required."; sendError.style.display = "block"; return; }
      if (!body) { sendError.textContent = "Message body is required."; sendError.style.display = "block"; return; }
      if (body.length > 1500) { sendError.textContent = "Message is too long."; sendError.style.display = "block"; return; }

      const imageUrl = getImageUrl();
      const msgType = imageUrl ? "MMS (with image)" : "SMS (text only)";
      const storeName = campaignStore.value ? (STORE_NAMES[campaignStore.value] || campaignStore.value) : "all stores";
      if (!confirm(`Send this ${msgType} campaign to all subscribed customers at ${storeName}?\n\nMessage:\n${body}\n\nReply STOP to opt out.`)) return;

      const btn = document.getElementById("btnSend");
      btn.disabled = true;
      btn.textContent = "Sending...";

      try {
        const payload = { name, body, store: campaignStore.value || undefined };
        if (imageUrl) payload.image_url = imageUrl;

        const resp = await fetch(`${WORKER_BASE}/admin/send`, {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify(payload),
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || "Failed to send.");

        sendSuccess.textContent = `Campaign sent! ${data.sent} delivered, ${data.failed} failed out of ${data.recipient_count} recipients.`;
        sendSuccess.style.display = "block";
        campaignName.value = "";
        campaignBody.value = "";
        charCount.textContent = "0 / 1,500";
        charCount.className = "char-count";
      } catch (e) {
        sendError.textContent = e.message;
        sendError.style.display = "block";
      } finally {
        btn.disabled = false;
        btn.textContent = "Send Campaign";
      }
    });

    // ─── Campaign History ────────────────────────────────────
    const campaignList = document.getElementById("campaignList");

    async function loadCampaigns() {
      try {
        const resp = await fetch(`${WORKER_BASE}/admin/campaigns`, { headers: authHeaders() });
        const campaigns = await resp.json();

        if (campaigns.length === 0) {
          campaignList.innerHTML = '<div class="empty">No campaigns sent yet.</div>';
          return;
        }

        campaignList.innerHTML = campaigns.map(c => `
          <div class="campaign-item" onclick="viewCampaign(${c.id})">
            <div class="campaign-name">${esc(c.name)}</div>
            <div class="campaign-meta">
              ${new Date(c.created_at).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric", hour: "numeric", minute: "2-digit" })}
              ${c.store_filter ? " &middot; " + (STORE_NAMES[c.store_filter] || c.store_filter) : " &middot; All Stores"}
            </div>
            <div class="campaign-stats">
              <span><span class="stat-label">Recipients:</span> ${c.recipient_count}</span>
              <span><span class="stat-label">Sent:</span> ${c.sent_count}</span>
              <span style="color:var(--green);"><span class="stat-label">Delivered:</span> ${c.delivered_count}</span>
              <span style="color:var(--red);"><span class="stat-label">Failed:</span> ${c.failed_count}</span>
            </div>
          </div>
        `).join("");
      } catch {
        campaignList.innerHTML = '<div class="error">Failed to load campaigns.</div>';
      }
    }

    // ─── Campaign Detail Modal ───────────────────────────────
    const campaignModal = document.getElementById("campaignModal");
    const campaignDetailTitle = document.getElementById("campaignDetailTitle");
    const campaignDetailBody = document.getElementById("campaignDetailBody");

    window.viewCampaign = async function(id) {
      campaignDetailTitle.textContent = "Loading...";
      campaignDetailBody.innerHTML = "";
      campaignModal.classList.add("open");

      try {
        const resp = await fetch(`${WORKER_BASE}/admin/campaigns/${id}`, { headers: authHeaders() });
        const data = await resp.json();

        campaignDetailTitle.textContent = data.name;
        let html = `
          <div style="font-size:13px;color:var(--dim);margin-bottom:12px;">
            ${new Date(data.created_at).toLocaleString()} &middot;
            ${data.store_filter ? (STORE_NAMES[data.store_filter] || data.store_filter) : "All Stores"}
          </div>
          <div style="background:rgba(0,0,0,.2);border-radius:8px;padding:12px;margin-bottom:16px;font-size:14px;white-space:pre-wrap;">${esc(data.body)}</div>
          <div class="campaign-stats" style="margin-bottom:16px;">
            <span>Recipients: <strong>${data.recipient_count}</strong></span>
            <span>Sent: <strong>${data.sent_count}</strong></span>
            <span style="color:var(--green);">Delivered: <strong>${data.delivered_count}</strong></span>
            <span style="color:var(--red);">Failed: <strong>${data.failed_count}</strong></span>
          </div>
        `;

        if (data.messages && data.messages.length > 0) {
          html += '<h2 style="font-size:14px;">Message Log</h2>';
          html += data.messages.map(m => `
            <div class="msg-row">
              <div>${esc(m.customer_name || "Unknown")} <span style="color:var(--dim);">${esc(m.customer_phone)}</span></div>
              <div class="msg-status msg-${m.status}">${m.status}${m.error_code ? ` (${m.error_code})` : ""}</div>
            </div>
          `).join("");
        }

        campaignDetailBody.innerHTML = html;
      } catch {
        campaignDetailBody.innerHTML = '<div class="error">Failed to load campaign details.</div>';
      }
    };

    document.getElementById("btnCampaignClose").addEventListener("click", () => {
      campaignModal.classList.remove("open");
    });

    // Close modals on overlay click
    [customerModal, campaignModal, inviteModal].forEach(modal => {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.remove("open");
      });
    });

    // ─── Phone formatting ──────────────────────────────────────
    function formatPhone(value) {
      let digits = value.replace(/\D/g, "");
      if (digits.length === 11 && digits.startsWith("1")) digits = digits.slice(1);
      digits = digits.slice(0, 10);
      if (digits.length <= 3) return digits;
      if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
      return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
    }
    modalPhone.addEventListener("input", () => {
      const pos = modalPhone.selectionStart;
      const before = modalPhone.value.length;
      modalPhone.value = formatPhone(modalPhone.value);
      const after = modalPhone.value.length;
      modalPhone.setSelectionRange(pos + (after - before), pos + (after - before));
    });

    // ─── Subscribe URL (HMAC-SHA256, matches worker logic) ──
    async function generateSubscribeToken(customerId) {
      const payload = `subscribe:${customerId}`;
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey(
        "raw", enc.encode(authToken),
        { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
      );
      const sig = await crypto.subtle.sign("HMAC", key, enc.encode(payload));
      const hmac = btoa(String.fromCharCode(...new Uint8Array(sig)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
      return btoa(`${customerId}:${hmac}`).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    document.getElementById("btnCopyUrl").addEventListener("click", () => {
      const urlInput = document.getElementById("modalSubscribeUrl");
      navigator.clipboard.writeText(urlInput.value).then(() => {
        const btn = document.getElementById("btnCopyUrl");
        btn.textContent = "Copied!";
        setTimeout(() => { btn.textContent = "Copy"; }, 1500);
      });
    });

    // ─── Utility ─────────────────────────────────────────────
    function esc(str) {
      if (!str) return "";
      const d = document.createElement("div");
      d.textContent = str;
      return d.innerHTML;
    }
  </script>
</body>
</html>
